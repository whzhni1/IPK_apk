name: åŒæ­¥ä¸Šæ¸¸å‘å¸ƒç‰ˆæœ¬

on:
  workflow_dispatch:

jobs:
  sync:
    name: åŒæ­¥ ${{ matrix.github_repo }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # OpenClash
          - github_owner: "vernesong"
            github_repo: "OpenClash"
            local_name: "luci-app-OpenClash"
            
          # luci-app-tailscale
          - github_owner: "whzhni1"
            github_repo: "luci-app-tailscale"
            local_name: "tailscale"
            
          # luci-app-lucky
          - github_owner: "gdy666"
            github_repo: "luci-app-lucky"
            local_name: "lucky"
            filter_include: "luci-app-*:1 luci-i18n-*:1 *wanji*"
            
          # luci-theme-aurora
          - github_owner: "eamonxg"
            github_repo: "luci-theme-aurora"
            
          # openwrt-passwall
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall"
            local_name: "luci-app-passwall"
            filter_exclude: "luci-19.07* *.zip"
            
          # openwrt-passwall2
          - github_owner: "xiaorouji"
            github_repo: "openwrt-passwall2"
            local_name: "luci-app-passwall2"
            filter_exclude: "luci-19.07* *.zip"

            
          # é…ç½®è¯´æ˜ï¼š
          # - github_owner: "ä½œè€…å"                    # å¿…å¡«
          # - github_repo: "é¡¹ç›®å"                      # å¿…å¡«  
          # - local_name: "æœ¬åˆ›å»ºä»“åº“å"                # å¯é€‰ï¼Œä¸è®¾ç½®åˆ™ä½¿ç”¨ github_repo
          # - filter_exclude: "*.zip *.rar"            # å¯é€‰ï¼Œæ’é™¤åŒ¹é…çš„æ–‡ä»¶ï¼ˆç©ºæ ¼åˆ†éš”å¤šä¸ªæ¨¡å¼ï¼‰
          # - filter_include: "*.ipk *zh-cn*"          # å¯é€‰ï¼Œåªä¿ç•™åŒ¹é…çš„æ–‡ä»¶
          # - filter_include: "luci-app-*:1"           # :1 è¡¨ç¤ºè¯¥æ¨¡å¼åªä¿ç•™ç¬¬1ä¸ªåŒ¹é…çš„æ–‡ä»¶
            
      fail-fast: false
      max-parallel: 3
      
    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/version-manager.sh
          
      - name: è®¾ç½®æœ¬åœ°åç§°
        id: set-names
        run: |
          local_name="${{ matrix.local_name }}"
          if [ -z "$local_name" ]; then
            local_name="${{ matrix.github_repo }}"
          fi
          
          echo "local_name=$local_name" >> $GITHUB_OUTPUT
          echo "ğŸ“ ä¸Šæ¸¸: ${{ matrix.github_repo }}"
          echo "ğŸ“‚ ä»“åº“: $local_name"
          
      - name: è·å–ä¸Šæ¸¸æœ€æ–°ç‰ˆæœ¬
        id: get-version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          github_owner="${{ matrix.github_owner }}"
          github_repo="${{ matrix.github_repo }}"
          full_repo="${github_owner}/${github_repo}"
          
          echo "ğŸ“¦ æ£€æŸ¥é¡¹ç›®: $full_repo"
          
          # è·å–æœ€æ–° Tag
          tags_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$full_repo/tags?per_page=1")
          
          if echo "$tags_response" | jq -e '.[0]' > /dev/null 2>&1; then
            latest_tag=$(echo "$tags_response" | jq -r '.[0].name')
            echo "ğŸ”– æœ€æ–° Tag: $latest_tag"
          else
            echo "âŒ æœªæ‰¾åˆ° Tag"
            echo "has_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # è·å– Release
          release_response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$full_repo/releases/tags/$latest_tag")
          
          if echo "$release_response" | jq -e '.assets' > /dev/null 2>&1; then
            echo "âœ… æ‰¾åˆ° Release"
            echo "$release_response" > /tmp/release.json
            echo "has_release=true" >> $GITHUB_OUTPUT
          else
            # å°è¯•æœ€æ–° Release
            latest_release=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/$full_repo/releases/latest")
            
            if echo "$latest_release" | jq -e '.assets' > /dev/null 2>&1; then
              latest_tag=$(echo "$latest_release" | jq -r '.tag_name')
              echo "âœ… ä½¿ç”¨æœ€æ–° Release: $latest_tag"
              echo "$latest_release" > /tmp/release.json
              echo "has_release=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ æœªæ‰¾åˆ° Release"
              echo "has_release=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # è§„èŒƒåŒ–ç‰ˆæœ¬å·
          if [[ "$latest_tag" =~ ^v ]]; then
            normalized_version="$latest_tag"
          else
            normalized_version="v$latest_tag"
          fi
          
          echo "version=$normalized_version" >> $GITHUB_OUTPUT
          
      - name: æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
        id: check-update
        if: steps.get-version.outputs.has_release == 'true'
        run: |
          local_name="${{ steps.set-names.outputs.local_name }}"
          latest_version="${{ steps.get-version.outputs.version }}"
          
          # è¯»å–æœ¬åœ°ç‰ˆæœ¬è®°å½•
          local_version=$(.github/workflows/scripts/version-manager.sh read "$local_name" 2>/dev/null || echo "")
          
          if [ -z "$local_version" ]; then
            echo "ğŸ“ æœ¬åœ°ç‰ˆæœ¬: æ— è®°å½•"
            echo "âœ… éœ€è¦å‘å¸ƒï¼ˆæ–°é¡¹ç›®ï¼‰"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "local_version=æ–°å»º" >> $GITHUB_OUTPUT
          elif [ "$local_version" != "$latest_version" ]; then
            echo "ğŸ“Œ æœ¬åœ°ç‰ˆæœ¬: $local_version"
            echo "ğŸ†• ä¸Šæ¸¸ç‰ˆæœ¬: $latest_version"
            echo "âœ… éœ€è¦æ›´æ–°"
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "local_version=$local_version" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“Œ å½“å‰ç‰ˆæœ¬: $local_version"
            echo "â„¹ï¸  å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "local_version=$local_version" >> $GITHUB_OUTPUT
          fi

      - name: ä¸‹è½½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        if: steps.check-update.outputs.needs_update == 'true'
        run: |
          latest_version="${{ steps.get-version.outputs.version }}"
          
          # ä½¿ç”¨ runner ä¸´æ—¶ç›®å½•
          DOWNLOAD_DIR="${{ runner.temp }}/downloads"
          mkdir -p "$DOWNLOAD_DIR"
          
          echo "ğŸ“‚ ä¸‹è½½ç›®å½•: $DOWNLOAD_DIR"
          
          latest_release=$(cat /tmp/release.json)
          download_count=$(echo "$latest_release" | jq '.assets | length')
          
          if [ "$download_count" -eq 0 ]; then
            echo "âš ï¸  æ— é™„ä»¶"
            echo "downloaded=false" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ $download_count ä¸ªæ–‡ä»¶"
          
          downloaded=0
          failed=0
          
          echo "$latest_release" | jq -r '.assets[] | "\(.browser_download_url)|\(.name)"' | while IFS='|' read -r url filename; do
            if [ -n "$url" ] && [ -n "$filename" ]; then
              if curl -L -f --max-time 300 -o "$DOWNLOAD_DIR/$filename" "$url" 2>/dev/null; then
                size=$(ls -lh "$DOWNLOAD_DIR/$filename" | awk '{print $5}')
                echo "  âœ… $filename ($size)"
                downloaded=$((downloaded + 1))
              else
                echo "  âŒ $filename"
                failed=$((failed + 1))
              fi
            fi
          done
          
          file_count=$(find "$DOWNLOAD_DIR" -type f 2>/dev/null | wc -l)
          
          echo ""
          echo "ğŸ“Š ä¸‹è½½å®Œæˆ: $file_count ä¸ªæ–‡ä»¶"
          
          if [ "$file_count" -eq 0 ]; then
           
