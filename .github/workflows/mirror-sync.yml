name: 同步文件到镜像

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'auto-update.sh'
      - 'auto-setup'

env:
  GITEE_USERNAME: whzhni
  GITCODE_USERNAME: whzhni
  REPO: ipk_apk
  BRANCH: main

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    steps:
      - name: 检出本仓库
        uses: actions/checkout@v4

      - name: 配置 Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 推送文件到 Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          mkdir sync-dir
          cp auto-update.sh auto-setup sync-dir/

          cd sync-dir
          git init
          git checkout -b ${{ env.BRANCH }}
          git remote add gitee https://oauth2:${GITEE_TOKEN}@gitee.com/${{ env.GITEE_USERNAME }}/${{ env.REPO }}.git

          git add .
          git commit -m "同步 auto-update.sh 和 auto-setup 文件"
          git push gitee ${{ env.BRANCH }} --force

  sync-to-gitcode:
    runs-on: ubuntu-latest
    steps:
      - name: 检出本仓库
        uses: actions/checkout@v4

      - name: 配置 Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: 推送文件到 GitCode
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
        run: |
          mkdir sync-dir
          cp auto-update.sh auto-setup sync-dir/

          cd sync-dir
          git init
          git checkout -b ${{ env.BRANCH }}
          git remote add gitcode https://oauth2:${GITCODE_TOKEN}@gitcode.com/${{ env.GITCODE_USERNAME }}/${{ env.REPO }}.git

          git add .
          git commit -m "同步 auto-update.sh 和 auto-setup 文件"
          git push gitcode ${{ env.BRANCH }} --force
