name: æµ‹è¯• Release å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'æµ‹è¯•å¹³å°'
        type: choice
        options:
          - 'Both (Parallel)'
          - 'GitCode'
          - 'Gitee'
        default: 'Both (Parallel)'
      
      tag_name:
        description: 'ç‰ˆæœ¬æ ‡ç­¾'
        default: 'v1.0.0-test'
      
      repo_name:
        description: 'ä»“åº“åç§°'
        default: 'test-release'

jobs:
  # ========================================
  # æµ‹è¯•ç‰ˆæœ¬ç®¡ç†å™¨
  # ========================================
  test-version-manager:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: æµ‹è¯• version-manager.sh
        run: |
          chmod +x .github/workflows/scripts/version-manager.sh
          export VERSION_FILE="${RUNNER_TEMP}/test-version.txt"
          
          echo "1. æµ‹è¯•å†™å…¥"
          .github/workflows/scripts/version-manager.sh write openlist2 v4.1.7
          cat $VERSION_FILE
          
          echo "2. æµ‹è¯•è¯»å–"
          VERSION=$(.github/workflows/scripts/version-manager.sh read openlist2)
          [ "$VERSION" = "v4.1.7" ] && echo "âœ… è¯»å–æˆåŠŸ: $VERSION" || exit 1
          
          echo "3. æµ‹è¯•æ›´æ–°"
          .github/workflows/scripts/version-manager.sh write openlist2 v4.1.8
          VERSION=$(.github/workflows/scripts/version-manager.sh read openlist2)
          [ "$VERSION" = "v4.1.8" ] && echo "âœ… æ›´æ–°æˆåŠŸ: $VERSION" || exit 1
          
          echo "4. æµ‹è¯•å¤šé¡¹ç›®"
          .github/workflows/scripts/version-manager.sh write tailscale v1.58.0
          .github/workflows/scripts/version-manager.sh list
          
          echo "5. æµ‹è¯•æ£€æŸ¥"
          .github/workflows/scripts/version-manager.sh check openlist2 && echo "âœ… å­˜åœ¨æ£€æŸ¥é€šè¿‡"
          ! .github/workflows/scripts/version-manager.sh check notexist && echo "âœ… ä¸å­˜åœ¨æ£€æŸ¥é€šè¿‡"
          
          echo "âœ… version-manager.sh æµ‹è¯•å®Œæˆ"

  # ========================================
  # å‡†å¤‡æµ‹è¯•æ–‡ä»¶
  # ========================================
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
        run: |
          mkdir -p files
          echo "# Test" > files/README.md
          echo "${{ inputs.tag_name }}" > files/version.txt
          echo "$(date)" > files/build-time.txt
          ls -lh files/

      - uses: actions/upload-artifact@v4
        with:
          name: test-files
          path: files/
          retention-days: 1

  # ========================================
  # å¹¶è¡Œå‘å¸ƒæµ‹è¯•
  # ========================================
  test-parallel:
    runs-on: ubuntu-latest
    needs: prepare
    if: inputs.platform == 'Both (Parallel)'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: é…ç½®è„šæœ¬
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh

      - uses: actions/download-artifact@v4
        with:
          name: test-files
          path: ${{ runner.temp }}/files

      - name: å¹¶è¡Œå‘å¸ƒ
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITCODE_USER: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          GITEE_USER: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
        run: |
          FILES=$(find ${{ runner.temp }}/files -type f | tr '\n' ' ')
          START=$(date +%s)
          
          # GitCode
          (
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="$GITCODE_USER" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="Test ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitCode å¹¶è¡Œæµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-GitCode.sh
          ) &
          PID1=$!
          
          # Gitee
          (
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="$GITEE_USER" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="Test ${{ inputs.tag_name }}" \
            RELEASE_BODY="Gitee å¹¶è¡Œæµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitee.sh
          ) &
          PID2=$!
          
          wait $PID1
          STATUS1=$?
          wait $PID2
          STATUS2=$?
          
          ELAPSED=$(($(date +%s) - START))
          
          echo "è€—æ—¶: ${ELAPSED}s"
          echo "GitCode: $([ $STATUS1 -eq 0 ] && echo 'âœ…' || echo 'âŒ')"
          echo "Gitee: $([ $STATUS2 -eq 0 ] && echo 'âœ…' || echo 'âŒ')"
          
          [ $STATUS1 -eq 0 ] && [ $STATUS2 -eq 0 ] || exit 1

  # ========================================
  # å•ç‹¬å‘å¸ƒæµ‹è¯•
  # ========================================
  test-single:
    runs-on: ubuntu-latest
    needs: prepare
    if: inputs.platform != 'Both (Parallel)'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: é…ç½®è„šæœ¬
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh

      - uses: actions/download-artifact@v4
        with:
          name: test-files
          path: ${{ runner.temp }}/files

      - name: å‘å¸ƒåˆ° ${{ inputs.platform }}
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          FILES=$(find ${{ runner.temp }}/files -type f | tr '\n' ' ')
          
          if [ "${{ inputs.platform }}" = "GitCode" ]; then
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="${{ secrets.GITCODE_USERNAME || 'whzhni' }}" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="Test ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitCode æµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            .github/workflows/scripts/release-GitCode.sh
          else
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="${{ secrets.GITEE_USERNAME || 'whzhni' }}" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="Test ${{ inputs.tag_name }}" \
            RELEASE_BODY="Gitee æµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            .github/workflows/scripts/release-gitee.sh
          fi

  # ========================================
  # æŠ¥å‘Š
  # ========================================
  report:
    runs-on: ubuntu-latest
    needs: [test-version-manager, test-parallel, test-single]
    if: always()
    
    steps:
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§ª æµ‹è¯•æŠ¥å‘Š
          
          **å¹³å°**: ${{ inputs.platform }}  
          **ç‰ˆæœ¬**: ${{ inputs.tag_name }}
          
          | æµ‹è¯•é¡¹ | ç»“æžœ |
          |--------|------|
          | ç‰ˆæœ¬ç®¡ç†å™¨ | ${{ needs.test-version-manager.result == 'success' && 'âœ…' || 'âŒ' }} |
          | å‘å¸ƒæµ‹è¯• | ${{ (needs.test-parallel.result == 'success' || needs.test-single.result == 'success') && 'âœ…' || 'âŒ' }} |
          EOF
          
          echo "::notice::æµ‹è¯•å®Œæˆ"
