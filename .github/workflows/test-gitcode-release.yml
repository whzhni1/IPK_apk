name: æµ‹è¯• Release å‘å¸ƒ

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'æµ‹è¯•å¹³å°'
        type: choice
        options:
          - 'All (Parallel)'
          - 'GitCode'
          - 'Gitee'
          - 'GitLab'
          - 'GitCode + Gitee'
          - 'GitCode + GitLab'
          - 'Gitee + GitLab'
        default: 'All (Parallel)'
      
      tag_name:
        description: 'ç‰ˆæœ¬æ ‡ç­¾'
        default: 'v1.0.0-test'
      
      repo_name:
        description: 'ä»“åº“åç§°'
        default: 'test-release'

jobs:
  # ========================================
  # æµ‹è¯•ç‰ˆæœ¬ç®¡ç†å™¨
  # ========================================
  test-version-manager:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: æµ‹è¯• version-manager.sh
        run: |
          chmod +x .github/workflows/scripts/version-manager.sh
          export VERSION_FILE="${RUNNER_TEMP}/test-version.txt"
          
          echo "1. æµ‹è¯•å†™å…¥"
          .github/workflows/scripts/version-manager.sh write openlist2 v4.1.7
          cat $VERSION_FILE
          
          echo "2. æµ‹è¯•è¯»å–"
          VERSION=$(.github/workflows/scripts/version-manager.sh read openlist2)
          [ "$VERSION" = "v4.1.7" ] && echo "âœ… è¯»å–æˆåŠŸ: $VERSION" || exit 1
          
          echo "3. æµ‹è¯•æ›´æ–°"
          .github/workflows/scripts/version-manager.sh write openlist2 v4.1.8
          VERSION=$(.github/workflows/scripts/version-manager.sh read openlist2)
          [ "$VERSION" = "v4.1.8" ] && echo "âœ… æ›´æ–°æˆåŠŸ: $VERSION" || exit 1
          
          echo "4. æµ‹è¯•å¤šé¡¹ç›®"
          .github/workflows/scripts/version-manager.sh write tailscale v1.58.0
          .github/workflows/scripts/version-manager.sh list
          
          echo "5. æµ‹è¯•æ£€æŸ¥"
          .github/workflows/scripts/version-manager.sh check openlist2 && echo "âœ… å­˜åœ¨æ£€æŸ¥é€šè¿‡"
          ! .github/workflows/scripts/version-manager.sh check notexist && echo "âœ… ä¸å­˜åœ¨æ£€æŸ¥é€šè¿‡"
          
          echo "âœ… version-manager.sh æµ‹è¯•å®Œæˆ"

  # ========================================
  # å‡†å¤‡æµ‹è¯•æ–‡ä»¶
  # ========================================
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
        run: |
          mkdir -p files
          echo "# Test" > files/README.md
          echo "${{ inputs.tag_name }}" > files/version.txt
          echo "$(date)" > files/build-time.txt
          ls -lh files/

      - uses: actions/upload-artifact@v4
        with:
          name: test-files
          path: files/
          retention-days: 1

  # ========================================
  # ä¸‰å¹³å°å¹¶è¡Œå‘å¸ƒæµ‹è¯•
  # ========================================
  test-all-parallel:
    runs-on: ubuntu-latest
    needs: prepare
    if: inputs.platform == 'All (Parallel)'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/release-gitlab.sh

      - uses: actions/download-artifact@v4
        with:
          name: test-files
          path: ${{ runner.temp }}/files

      - name: ä¸‰å¹³å°å¹¶è¡Œå‘å¸ƒ
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITCODE_USER: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          GITEE_USER: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
          GITLAB_USER: ${{ secrets.GITLAB_USERNAME || 'whzhni' }}
        run: |
          FILES=$(find ${{ runner.temp }}/files -type f | tr '\n' ' ')
          START=$(date +%s)
          
          # GitCode å‘å¸ƒ
          (
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="$GITCODE_USER" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitCode ä¸‰å¹³å°å¹¶è¡Œæµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-GitCode.sh
          ) &
          PID1=$!
          
          # Gitee å‘å¸ƒ
          (
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="$GITEE_USER" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="Gitee ä¸‰å¹³å°å¹¶è¡Œæµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitee.sh
          ) &
          PID2=$!
          
          # GitLab å‘å¸ƒ
          (
            GITLAB_TOKEN="$GITLAB_TOKEN" \
            USERNAME="$GITLAB_USER" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitLab ä¸‰å¹³å°å¹¶è¡Œæµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitlab.sh
          ) &
          PID3=$!
          
          wait $PID1
          STATUS1=$?
          wait $PID2
          STATUS2=$?
          wait $PID3
          STATUS3=$?
          
          ELAPSED=$(($(date +%s) - START))
          
          echo "æ€»è€—æ—¶: ${ELAPSED}s"
          echo "GitCode: $([ $STATUS1 -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          echo "Gitee: $([ $STATUS2 -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          echo "GitLab: $([ $STATUS3 -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          
          [ $STATUS1 -eq 0 ] && [ $STATUS2 -eq 0 ] && [ $STATUS3 -eq 0 ] || exit 1

  # ========================================
  # åŒå¹³å°å¹¶è¡Œå‘å¸ƒæµ‹è¯•
  # ========================================
  test-dual-parallel:
    runs-on: ubuntu-latest
    needs: prepare
    if: |
      inputs.platform == 'GitCode + Gitee' || 
      inputs.platform == 'GitCode + GitLab' || 
      inputs.platform == 'Gitee + GitLab'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/release-gitlab.sh

      - uses: actions/download-artifact@v4
        with:
          name: test-files
          path: ${{ runner.temp }}/files

      - name: åŒå¹³å°å¹¶è¡Œå‘å¸ƒ
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITCODE_USER: ${{ secrets.GITCODE_USERNAME || 'whzhni' }}
          GITEE_USER: ${{ secrets.GITEE_USERNAME || 'whzhni' }}
          GITLAB_USER: ${{ secrets.GITLAB_USERNAME || 'whzhni' }}
        run: |
          FILES=$(find ${{ runner.temp }}/files -type f | tr '\n' ' ')
          START=$(date +%s)
          
          # GitCode + Gitee
          if [ "${{ inputs.platform }}" = "GitCode + Gitee" ]; then
            (
              GITCODE_TOKEN="$GITCODE_TOKEN" \
              USERNAME="$GITCODE_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="GitCode åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-GitCode.sh
            ) &
            PID1=$!
            
            (
              GITEE_TOKEN="$GITEE_TOKEN" \
              USERNAME="$GITEE_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="Gitee åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-gitee.sh
            ) &
            PID2=$!
          fi
          
          # GitCode + GitLab
          if [ "${{ inputs.platform }}" = "GitCode + GitLab" ]; then
            (
              GITCODE_TOKEN="$GITCODE_TOKEN" \
              USERNAME="$GITCODE_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="GitCode åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-GitCode.sh
            ) &
            PID1=$!
            
            (
              GITLAB_TOKEN="$GITLAB_TOKEN" \
              USERNAME="$GITLAB_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="GitLab åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-gitlab.sh
            ) &
            PID2=$!
          fi
          
          # Gitee + GitLab
          if [ "${{ inputs.platform }}" = "Gitee + GitLab" ]; then
            (
              GITEE_TOKEN="$GITEE_TOKEN" \
              USERNAME="$GITEE_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="Gitee åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-gitee.sh
            ) &
            PID1=$!
            
            (
              GITLAB_TOKEN="$GITLAB_TOKEN" \
              USERNAME="$GITLAB_USER" \
              REPO_NAME="${{ inputs.repo_name }}" \
              TAG_NAME="${{ inputs.tag_name }}" \
              RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
              RELEASE_BODY="GitLab åŒå¹³å°å¹¶è¡Œæµ‹è¯•" \
              UPLOAD_FILES="$FILES" \
              RUNNER_TEMP="${{ runner.temp }}" \
              .github/workflows/scripts/release-gitlab.sh
            ) &
            PID2=$!
          fi
          
          wait $PID1
          STATUS1=$?
          wait $PID2
          STATUS2=$?
          
          ELAPSED=$(($(date +%s) - START))
          
          echo "æ€»è€—æ—¶: ${ELAPSED}s"
          echo "å¹³å°1: $([ $STATUS1 -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          echo "å¹³å°2: $([ $STATUS2 -eq 0 ] && echo 'âœ… æˆåŠŸ' || echo 'âŒ å¤±è´¥')"
          
          [ $STATUS1 -eq 0 ] && [ $STATUS2 -eq 0 ] || exit 1

  # ========================================
  # å•å¹³å°å‘å¸ƒæµ‹è¯•
  # ========================================
  test-single:
    runs-on: ubuntu-latest
    needs: prepare
    if: |
      inputs.platform == 'GitCode' || 
      inputs.platform == 'Gitee' || 
      inputs.platform == 'GitLab'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: é…ç½®è„šæœ¬æƒé™
        run: |
          chmod +x .github/workflows/scripts/release-GitCode.sh
          chmod +x .github/workflows/scripts/release-gitee.sh
          chmod +x .github/workflows/scripts/release-gitlab.sh

      - uses: actions/download-artifact@v4
        with:
          name: test-files
          path: ${{ runner.temp }}/files

      - name: å‘å¸ƒåˆ° ${{ inputs.platform }}
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          FILES=$(find ${{ runner.temp }}/files -type f | tr '\n' ' ')
          
          if [ "${{ inputs.platform }}" = "GitCode" ]; then
            GITCODE_TOKEN="$GITCODE_TOKEN" \
            USERNAME="${{ secrets.GITCODE_USERNAME || 'whzhni' }}" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitCode å•å¹³å°æµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-GitCode.sh
            
          elif [ "${{ inputs.platform }}" = "Gitee" ]; then
            GITEE_TOKEN="$GITEE_TOKEN" \
            USERNAME="${{ secrets.GITEE_USERNAME || 'whzhni' }}" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="Gitee å•å¹³å°æµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitee.sh
            
          elif [ "${{ inputs.platform }}" = "GitLab" ]; then
            GITLAB_TOKEN="$GITLAB_TOKEN" \
            USERNAME="${{ secrets.GITLAB_USERNAME || 'whzhni' }}" \
            REPO_NAME="${{ inputs.repo_name }}" \
            TAG_NAME="${{ inputs.tag_name }}" \
            RELEASE_TITLE="æµ‹è¯• ${{ inputs.tag_name }}" \
            RELEASE_BODY="GitLab å•å¹³å°æµ‹è¯•" \
            UPLOAD_FILES="$FILES" \
            RUNNER_TEMP="${{ runner.temp }}" \
            .github/workflows/scripts/release-gitlab.sh
          fi
          
          echo "âœ… ${{ inputs.platform }} å‘å¸ƒå®Œæˆ"

  # ========================================
  # æµ‹è¯•æŠ¥å‘Š
  # ========================================
  report:
    runs-on: ubuntu-latest
    needs: [test-version-manager, test-all-parallel, test-dual-parallel, test-single]
    if: always()
    
    steps:
      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§ª æµ‹è¯•æŠ¥å‘Š
          
          **æµ‹è¯•å¹³å°**: ${{ inputs.platform }}  
          **ç‰ˆæœ¬æ ‡ç­¾**: ${{ inputs.tag_name }}  
          **ä»“åº“åç§°**: ${{ inputs.repo_name }}
          
          | æµ‹è¯•é¡¹ | ç»“æžœ |
          |--------|------|
          | ç‰ˆæœ¬ç®¡ç†å™¨ | ${{ needs.test-version-manager.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |
          | ä¸‰å¹³å°å¹¶è¡Œ | ${{ needs.test-all-parallel.result == 'success' && 'âœ… æˆåŠŸ' || (needs.test-all-parallel.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |
          | åŒå¹³å°å¹¶è¡Œ | ${{ needs.test-dual-parallel.result == 'success' && 'âœ… æˆåŠŸ' || (needs.test-dual-parallel.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |
          | å•å¹³å°å‘å¸ƒ | ${{ needs.test-single.result == 'success' && 'âœ… æˆåŠŸ' || (needs.test-single.result == 'skipped' && 'â­ï¸ è·³è¿‡' || 'âŒ å¤±è´¥') }} |
          
          ---
          
          ### ðŸ“‹ éœ€è¦é…ç½®çš„ Secrets
          
          - \`GITCODE_TOKEN\` - GitCode è®¿é—®ä»¤ç‰Œ
          - \`GITEE_TOKEN\` - Gitee è®¿é—®ä»¤ç‰Œ  
          - \`GITLAB_TOKEN\` - GitLab è®¿é—®ä»¤ç‰Œ
          - \`GITCODE_USERNAME\` - GitCode ç”¨æˆ·å (å¯é€‰ï¼Œé»˜è®¤: whzhni)
          - \`GITEE_USERNAME\` - Gitee ç”¨æˆ·å (å¯é€‰ï¼Œé»˜è®¤: whzhni)
          - \`GITLAB_USERNAME\` - GitLab ç”¨æˆ·å (å¯é€‰ï¼Œé»˜è®¤: whzhni)
          
          ### ðŸ”— ä»“åº“é“¾æŽ¥
          
          - [GitCode](https://gitcode.com/\${{ secrets.GITCODE_USERNAME || 'whzhni' }}/${{ inputs.repo_name }})
          - [Gitee](https://gitee.com/\${{ secrets.GITEE_USERNAME || 'whzhni' }}/${{ inputs.repo_name }})
          - [GitLab](https://gitlab.com/\${{ secrets.GITLAB_USERNAME || 'whzhni' }}/${{ inputs.repo_name }})
          EOF
          
          echo "::notice::æµ‹è¯•å®Œæˆï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹ Summary"
