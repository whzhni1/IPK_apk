name: æµ‹è¯• Release è„šæœ¬

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'æ‰§è¡Œæ“ä½œ'
        required: true
        type: choice
        options:
          - 'åˆ›å»ºRelease'
          - 'åˆ é™¤ä»“åº“'
        default: 'åˆ›å»ºRelease'
      
      platform:
        description: 'æµ‹è¯•å¹³å°'
        required: true
        type: choice
        options:
          - 'all'
          - 'gitcode'
          - 'gitee'
          - 'gitlab'
        default: 'all'
      
      USERNAME:
        description: 'ä½œè€…å'
        required: true
        default: 'whzhni'
      
      Project_Name:
        description: 'é¡¹ç›®å'
        required: true
        default: 'test-release'
      
      tag_name:
        description: 'Release æ ‡ç­¾å'
        required: true
        default: 'v1.0.0-test'
      
      release_title:
        description: 'Release æ ‡é¢˜'
        required: true
        default: 'æµ‹è¯• Release'
      
      enable_version_write:
        description: 'å†™å…¥ç‰ˆæœ¬åˆ° version-manager.sh'
        required: true
        type: boolean
        default: false

env:
  USERNAME: ${{ github.event.inputs.USERNAME }}
  REPO_NAME: ${{ github.event.inputs.Project_Name }}
  TAG_NAME: ${{ github.event.inputs.tag_name }}
  RELEASE_TITLE: ${{ github.event.inputs.release_title }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.set-matrix.outputs.platforms }}
    steps:
      - name: è®¾ç½®å¹³å°çŸ©é˜µ
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.platform }}" = "all" ]; then
            echo "platforms=[\"gitcode\",\"gitee\",\"gitlab\"]" >> $GITHUB_OUTPUT
          else
            echo "platforms=[\"${{ github.event.inputs.platform }}\"]" >> $GITHUB_OUTPUT
          fi
      
      - name: æ˜¾ç¤ºé…ç½®
        run: |
          echo "### ðŸ§ª æµ‹è¯•é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- **æ“ä½œ**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: ${{ github.event.inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¡¹ç›®**: ${{ env.USERNAME }}/${{ env.REPO_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ ‡ç­¾**: ${{ env.TAG_NAME }}" >> $GITHUB_STEP_SUMMARY

  execute:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: ${{ fromJson(needs.prepare.outputs.platforms) }}
      fail-fast: false
    name: ${{ github.event.inputs.action }} - ${{ matrix.platform }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: åˆ›å»ºæµ‹è¯•æ–‡ä»¶
        if: github.event.inputs.action == 'åˆ›å»ºRelease'
        run: |
          echo "æž„å»ºæ—¶é—´: $(date)" > build-time.txt
          echo "ç‰ˆæœ¬: ${{ env.TAG_NAME }}" > version.txt
          echo "# æµ‹è¯• Release" > README.md
      
      - name: å†™å…¥ç‰ˆæœ¬ä¿¡æ¯
        if: github.event.inputs.action == 'åˆ›å»ºRelease' && github.event.inputs.enable_version_write == 'true'
        run: |
          [ -f "version-manager.sh" ] && chmod +x version-manager.sh && ./version-manager.sh set "${{ env.TAG_NAME }}"
      
      - name: æ‰§è¡Œæ“ä½œ
        env:
          GITCODE_TOKEN: ${{ secrets.GITCODE_TOKEN }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          PLATFORM: ${{ matrix.platform }}
          ACTION: ${{ github.event.inputs.action }}
          RELEASE_BODY: "${{ matrix.platform }} æµ‹è¯•"
          UPLOAD_FILES: "build-time.txt version.txt README.md"
        run: |
          chmod +x .github/workflows/scripts/*.sh
          if [ "$ACTION" = "åˆ›å»ºRelease" ]; then
            ./.github/workflows/scripts/release-${PLATFORM}.sh
          else
            ./.github/workflows/scripts/delete-repo.sh "$PLATFORM"
          fi

  summary:
    needs: [prepare, execute]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ç”ŸæˆæŠ¥å‘Š
        run: |
          echo "# ðŸ“Š æ‰§è¡Œç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **æ“ä½œ**: ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¹³å°**: ${{ github.event.inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: ${{ needs.execute.result == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
